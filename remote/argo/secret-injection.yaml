apiVersion: batch/v1
kind: Job
metadata:
  name: inject-secrets-job
  annotations:
    "argocd.argoproj.io/hook": PreSync
    "argocd.argoproj.io/hook-delete-policy": HookSucceeded
spec:
  template:
    spec:
      containers:
      - name: inject-secrets
        image: alpine:latest
        command: ["/bin/sh", "-c"]
        args:
        - |
          echo "Injecting DB secrets..."
          kubectl create secret generic db-secrets-job \
            --from-literal=dsn='postgres://harry:password@postgres-database:5432/expenses?sslmode=disable' \
            --from-literal=maxOpenConn=30 \
            --from-literal=maxIdleConn=30 \
            --dry-run=client -o yaml | kubectl apply -f -
      restartPolicy: Never
  backoffLimit: 3
